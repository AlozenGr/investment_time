<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Venda Coberta – Revisado (Seguro)</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid #e2e8f0;background:#fff;border-radius:12px;padding:.5rem .75rem;font-size:.875rem;font-weight:600}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .input{width:100%;border:1px solid #cbd5e1;border-radius:12px;padding:.5rem .75rem;font-size:.875rem;outline:none}
    .label{display:block;font-size:.75rem;font-weight:700;color:#475569;margin-bottom:.25rem}
    .table-head{background:#f8fafc;color:#64748b;font-size:.75rem}
    .table-cell{white-space:nowrap;padding:.5rem .75rem;font-size:.875rem}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
<header class="bg-white border-b border-slate-100">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="h-9 w-9 grid place-content-center rounded-xl bg-slate-900 text-white text-lg font-bold">₿</div>
      <div>
        <h1 class="text-lg font-semibold">Venda Coberta – Dashboard</h1>
        <p class="text-xs text-slate-500">Conectado ao Google Sheets (Apps Script)</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnExport" class="btn">Exportar CSV</button>
      <a class="btn" href="#config">Configurar API</a>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
  <section id="config" class="card p-4">
    <h2 class="font-semibold mb-2">Configuração da API (cole e salve)</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div><label class="label">WEB_APP_URL</label><input id="cfgUrl" class="input" placeholder="https://script.google.com/macros/s/.../exec"></div>
      <div><label class="label">API_KEY</label><input id="cfgKey" class="input" placeholder="sua-chave-secreta"></div>
    </div>
    <div class="mt-3 flex gap-2 items-center"><button class="btn btn-primary" id="btnSalvarCfg">Salvar</button><span class="text-xs text-slate-500" id="cfgStatus">—</span></div>
    <p class="text-xs text-slate-500 mt-2">Se publicar um novo deploy do Apps Script, atualize a URL e clique em Salvar.</p>
  </section>

  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="card p-4">
      <h2 class="font-semibold mb-2">Carteira</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="table-head"><tr><th class="table-cell text-left">Ticker</th><th class="table-cell text-right">Qtde</th><th class="table-cell text-right">Preço Médio</th><th class="table-cell text-right">Preço Atual</th><th class="table-cell text-right">VM</th><th class="table-cell text-right">Latente</th></tr></thead>
          <tbody id="tbCarteira"></tbody>
        </table>
      </div>
    </div>
    <div class="card p-4">
      <h2 class="font-semibold mb-2">Opções Cobertas</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="table-head"><tr><th class="table-cell text-left">Subjacente</th><th class="table-cell text-left">Código</th><th class="table-cell text-right">Qtde</th><th class="table-cell text-right">Strike</th><th class="table-cell text-right">Prêmio</th><th class="table-cell text-center">Venc.</th><th class="table-cell text-center">Status</th><th class="table-cell text-right">Resultado</th></tr></thead>
          <tbody id="tbOpcoes"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <form class="card p-4 space-y-3" id="formAporte">
      <div><h3 class="font-semibold">Registrar Aporte</h3></div>
      <div><label class="label">Data</label><input type="date" name="data" class="input" required></div>
      <div><label class="label">Valor (R$)</label><input type="number" name="valor" step="0.01" class="input" required></div>
      <button class="btn btn-primary w-full">Adicionar</button>
    </form>
    <form class="card p-4 space-y-3" id="formCompra">
      <div><h3 class="font-semibold">Comprar Ação</h3></div>
      <div><label class="label">Ticker</label><input name="ticker" class="input" required></div>
      <div class="grid grid-cols-2 gap-3"><div><label class="label">Qtde</label><input type="number" name="qtde" class="input" required></div><div><label class="label">Preço (R$)</label><input type="number" name="preco" step="0.01" class="input" required></div></div>
      <div><label class="label">Data</label><input type="date" name="data" class="input" required></div>
      <button class="btn btn-primary w-full">Adicionar</button>
    </form>
    <form class="card p-4 space-y-3" id="formCall">
      <div><h3 class="font-semibold">Vender Call Coberta</h3></div>
      <div class="grid grid-cols-2 gap-3"><div><label class="label">Subjacente</label><input name="subj" class="input" required></div><div><label class="label">Código</label><input name="codigo" class="input" required></div></div>
      <div class="grid grid-cols-3 gap-3"><div><label class="label">Qtde</label><input type="number" name="qtde" class="input" required></div><div><label class="label">Strike (R$)</label><input type="number" name="strike" step="0.01" class="input" required></div><div><label class="label">Prêmio (R$)</label><input type="number" name="premio" step="0.01" class="input" required></div></div>
      <div class="grid grid-cols-2 gap-3"><div><label class="label">Data Venda</label><input type="date" name="dataVenda" class="input" required></div><div><label class="label">Vencimento</label><input type="date" name="venc" id="inVenc" class="input" required></div></div>
      <button class="btn btn-primary w-full">Registrar</button>
    </form>
  </section>

  <section class="card p-4">
    <h2 class="font-semibold mb-2">Evolução do Patrimônio</h2>
    <canvas id="chartPatrimonio" height="140"></canvas>
  </section>
</main>

<script>
  // -------- Config --------
  (function(){
    if(!localStorage.getItem('WEB_APP_URL')) localStorage.setItem('WEB_APP_URL', 'https://script.google.com/macros/s/AKfycbxmKHLjwPiItIJaTpr35VASgtIWkJ-zAbIMeP6XVvvH-HEH229js1xk4j8M7ZCHfL1IRg/exec');
    if(!localStorage.getItem('API_KEY')) localStorage.setItem('API_KEY', 'Vc7@Rendimentos#2025!');
  })();
  function cfgGet(k){ return localStorage.getItem(k)||''; }
  function cfgSet(k,v){ localStorage.setItem(k,v); }
  document.addEventListener('DOMContentLoaded', function(){
    document.getElementById('cfgUrl').value = cfgGet('WEB_APP_URL');
    document.getElementById('cfgKey').value = cfgGet('API_KEY');
    document.getElementById('btnSalvarCfg').onclick = function(){
      cfgSet('WEB_APP_URL', document.getElementById('cfgUrl').value.trim());
      cfgSet('API_KEY', document.getElementById('cfgKey').value.trim());
      document.getElementById('cfgStatus').textContent = 'Configuração salva.';
      loadAll();
    };
  });

  // -------- API --------
  function apiGet(resource){
    var url = cfgGet('WEB_APP_URL');
    var key = cfgGet('API_KEY');
    if(!url) return Promise.reject(new Error('Configure a WEB_APP_URL'));
    var full = url + '?resource=' + encodeURIComponent(resource) + '&key=' + encodeURIComponent(key);
    return fetch(full).then(function(r){ return r.json(); }).then(function(j){
      if(!j.ok) throw new Error(j.error||'erro');
      return j.data||[];
    });
  }
  function apiPost(payload){
    var url = cfgGet('WEB_APP_URL');
    var key = cfgGet('API_KEY');
    if(!url) return Promise.reject(new Error('Configure a WEB_APP_URL'));
    payload.key = key;
    return fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)})
      .then(function(r){ return r.json(); })
      .then(function(j){ if(!j.ok) throw new Error(j.error||'erro'); return j.data; });
  }

  // -------- Estado --------
  var store = { acoes: [], calls: [], aportes: [], compras: [], caixa: 0 };

  // -------- Render --------
  function renderCarteira(){
    var tb = document.getElementById('tbCarteira'); tb.innerHTML='';
    store.acoes.forEach(function(a){
      var precoAtual = a.precoAtual || a.preco || 0;
      var vm = (a.qtde||0)*precoAtual;
      var lat = (precoAtual - (a.precoMedio||a.preco||0))*(a.qtde||0);
      var tr = document.createElement('tr');
      tr.innerHTML = '<td class="table-cell">'+(a.ticker||'')+'</td>' +
                     '<td class="table-cell text-right">'+(a.qtde||0)+'</td>' +
                     '<td class="table-cell text-right">'+fmt(a.precoMedio||a.preco||0)+'</td>' +
                     '<td class="table-cell text-right">'+fmt(precoAtual)+'</td>' +
                     '<td class="table-cell text-right">'+fmt(vm)+'</td>' +
                     '<td class="table-cell text-right">'+fmt(lat)+'</td>';
      tb.appendChild(tr);
    });
  }
  function renderOpcoes(){
    var tb = document.getElementById('tbOpcoes'); tb.innerHTML='';
    store.calls.forEach(function(c){
      var tr = document.createElement('tr');
      tr.innerHTML = '<td class="table-cell">'+(c.subjacente||'')+'</td>' +
                     '<td class="table-cell">'+(c.codigo||'')+'</td>' +
                     '<td class="table-cell text-right">'+(c.qtde||0)+'</td>' +
                     '<td class="table-cell text-right">'+fmt(Number(c.strike||0))+'</td>' +
                     '<td class="table-cell text-right">'+fmt(Number(c.premio||0))+'</td>' +
                     '<td class="table-cell text-center">'+(c.vencimento? new Date(c.vencimento).toLocaleDateString('pt-BR') : '')+'</td>' +
                     '<td class="table-cell text-center">'+(c.status||'')+'</td>' +
                     '<td class="table-cell text-right">'+fmt(Number(c.resultado||0))+'</td>';
      tb.appendChild(tr);
    });
  }

  // -------- Utils --------
  var BRL = new Intl.NumberFormat('pt-BR', {style:'currency',currency:'BRL'});
  function fmt(v){ return BRL.format(v||0); }

  // -------- Forms --------
  document.getElementById('formAporte').onsubmit = function(e){
    e.preventDefault();
    var fd = new FormData(e.target);
    apiPost({action:'aportes/create', data: fd.get('data'), valor: Number(fd.get('valor')||0), observacao:''})
      .then(function(){ e.target.reset(); return loadAll(); })
      .catch(function(err){ alert(err.message); });
  };
  document.getElementById('formCompra').onsubmit = function(e){
    e.preventDefault();
    var fd = new FormData(e.target);
    apiPost({action:'compras/create', data: fd.get('data'), ticker: (fd.get('ticker')||'').toUpperCase(), qtde: Number(fd.get('qtde')||0), preco: Number(fd.get('preco')||0)})
      .then(function(){ e.target.reset(); return loadAll(); })
      .catch(function(err){ alert(err.message); });
  };
  document.getElementById('formCall').onsubmit = function(e){
    e.preventDefault();
    var fd = new FormData(e.target);
    apiPost({action:'opcoes/create', data_venda: fd.get('dataVenda'), vencimento: fd.get('venc'), subjacente: (fd.get('subj')||'').toUpperCase(), codigo: (fd.get('codigo')||'').toUpperCase(), qtde: Number(fd.get('qtde')||0), strike: Number(fd.get('strike')||0), premio: Number(fd.get('premio')||0), status:'Aberta', resultado:0})
      .then(function(){ e.target.reset(); return loadAll(); })
      .catch(function(err){ alert(err.message); });
  };

  // -------- Charts (apenas exemplo) --------
  var ch;
  function renderChart(){
    var ctx = document.getElementById('chartPatrimonio').getContext('2d');
    if(ch) ch.destroy();
    ch = new Chart(ctx, {type:'line', data:{labels:['Jan','Fev','Mar'], datasets:[{label:'Patrimônio', data:[1000,1200,1500]}]}, options:{plugins:{legend:{display:false}}}});
  }

  // -------- Load --------
  function loadAll(){
    return Promise.all([apiGet('aportes'), apiGet('compras'), apiGet('opcoes')])
      .then(function(arr){
        store.aportes = arr[0]; store.compras = arr[1]; store.calls = arr[2];
        // carteira a partir de compras
        var acc = [];
        store.compras.forEach(function(c){
          var k = c.ticker;
          var x = null;
          for(var i=0;i<acc.length;i++){ if(acc[i].ticker===k){ x = acc[i]; break; } }
          if(!x){ x = {ticker:k, qtde:0, preco:0, precoMedio:0, precoAtual:c.preco}; acc.push(x); }
          var qtd = Number(c.qtde||0), pr = Number(c.preco||0);
          var custo = qtd*pr, qtdAnt = x.qtde;
          x.qtde += qtd;
          x.precoMedio = ((x.precoMedio*qtdAnt) + custo) / (x.qtde||1);
          x.precoAtual = pr;
        });
        store.acoes = acc;
        renderCarteira(); renderOpcoes(); renderChart();
      })
      .catch(function(err){
        document.getElementById('cfgStatus').textContent = 'Erro: ' + err.message;
        console.warn(err);
      });
  }
  loadAll();
</script>
</body>
</html>
