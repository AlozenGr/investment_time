<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>💼 Controle – Venda Coberta</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{border:1px solid #e2e8f0;border-radius:14px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .input{border:1px solid #cbd5e1;border-radius:10px;padding:.6rem .8rem;width:100%;}
    .btn{border:1px solid #0ea5e9;background:#0284c7;color:#fff;border-radius:10px;padding:.6rem 1rem;font-weight:600;}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .tab{cursor:pointer;padding:.5rem 1rem;border-radius:999px;border:1px solid #cbd5e1;background:#fff;}
    .tab.active{background:#0284c7;border-color:#0284c7;color:#fff;}
    .table th, .table td{border-bottom:1px solid #e2e8f0;padding:.55rem .6rem;text-align:left;white-space:nowrap}
    .table{width:100%;overflow:auto}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="p-4 md:p-6 bg-white shadow flex items-center justify-between">
    <div class="flex items-center gap-3">
      <h1 class="text-xl md:text-2xl font-bold">💼 Controle – Venda Coberta</h1>
      <span class="text-sm text-slate-500 hidden md:inline">Aportes, Compras, Opções, Encerramentos, IR</span>
    </div>
    <div class="flex items-center gap-3 text-sm">
      <button id="btnReload" class="btn">Recarregar Listas</button>
    </div>
  </header>

  <main class="p-4 md:p-6 space-y-6">
    <!-- Config -->
    <section class="card p-4 md:p-6">
      <h2 class="text-lg font-semibold mb-3">Configuração do Endpoint</h2>
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-slate-600">API URL</label>
          <input id="apiUrl" class="input" value="https://script.google.com/macros/s/AKfycbzpnjwbV6UnNTKTuO_1sabDMelgS__4dTV7oxd8WFltEssboPRb2RBQQJLXu5WuFOrKNQ/exec" />
        </div>
        <div>
          <label class="text-sm text-slate-600">API KEY</label>
          <input id="apiKey" class="input" value="Vc7@Rendimentos#2025!" />
        </div>
      </div>
      <div class="mt-3 text-sm text-slate-500">Mantenha a URL e a KEY sincronizadas com o Apps Script (implantado como Web App – acesso: Anyone).</div>
    </section>

    <!-- Abas -->
    <section class="card p-4 md:p-6">
      <div class="flex flex-wrap gap-2 mb-4">
        <button data-tab="aportes" class="tab active">Aportes</button>
        <button data-tab="compras" class="tab">Compras</button>
        <button data-tab="opcoes" class="tab">Opções</button>
        <button data-tab="encerr" class="tab">Encerramentos</button>
        <button data-tab="mensal" class="tab">Mensal</button>
        <button data-tab="ir" class="tab">IR</button>
      </div>

      <!-- LISTAS -->
      <div id="listArea" class="space-y-6">
        <div id="list-aportes"></div>
        <div id="list-compras" class="hidden"></div>
        <div id="list-opcoes" class="hidden"></div>
        <div id="list-encerr" class="hidden"></div>
        <div id="list-mensal" class="hidden"></div>
        <div id="list-ir" class="hidden"></div>
      </div>

      <hr class="my-6" />

      <!-- FORMULÁRIOS -->
      <div id="formsArea" class="space-y-6">
        <!-- Aportes -->
        <div id="form-aportes">
          <h3 class="font-semibold mb-2">Novo Aporte</h3>
          <div class="grid md:grid-cols-4 gap-3">
            <input id="ap_data" class="input" placeholder="Data (YYYY-MM-DD)" />
            <input id="ap_valor" class="input" type="number" step="0.01" placeholder="Valor" />
            <input id="ap_obs" class="input" placeholder="Observação" />
            <button id="ap_submit" class="btn">Adicionar</button>
          </div>
        </div>

        <!-- Compras -->
        <div id="form-compras" class="hidden">
          <h3 class="font-semibold mb-2">Nova Compra</h3>
          <div class="grid md:grid-cols-6 gap-3">
            <input id="co_data" class="input" placeholder="Data (YYYY-MM-DD)" />
            <input id="co_ticker" class="input" placeholder="Ticker" />
            <input id="co_qtde" class="input" type="number" step="1" placeholder="Qtde" />
            <input id="co_preco" class="input" type="number" step="0.01" placeholder="Preço" />
            <div class="md:col-span-1"></div>
            <button id="co_submit" class="btn md:col-span-1">Adicionar</button>
          </div>
        </div>

        <!-- Opções -->
        <div id="form-opcoes" class="hidden">
          <h3 class="font-semibold mb-2">Nova Venda de Opção</h3>
          <div class="grid md:grid-cols-6 gap-3">
            <input id="op_data_venda" class="input" placeholder="Data venda (YYYY-MM-DD)" />
            <input id="op_venc" class="input" placeholder="Vencimento (YYYY-MM-DD)" />
            <input id="op_subj" class="input" placeholder="Subjacente (ex: PETR4)" />
            <input id="op_codigo" class="input" placeholder="Código (ex: PETRA30)" />
            <input id="op_qtde" class="input" type="number" step="1" placeholder="Qtde" />
            <input id="op_strike" class="input" type="number" step="0.01" placeholder="Strike" />
            <input id="op_premio" class="input" type="number" step="0.01" placeholder="Prêmio R$" />
            <button id="op_submit" class="btn md:col-span-1">Adicionar</button>
          </div>
        </div>

        <!-- Encerramentos -->
        <div id="form-encerr" class="hidden">
          <h3 class="font-semibold mb-2">Novo Encerramento</h3>
          <div class="grid md:grid-cols-6 gap-3">
            <input id="en_codigo" class="input" placeholder="Código Opção" />
            <input id="en_data" class="input" placeholder="Data fechamento (YYYY-MM-DD)" />
            <input id="en_preco" class="input" type="number" step="0.01" placeholder="Preço Ação" />
            <input id="en_custo" class="input" type="number" step="0.01" placeholder="Custo Fechar" />
            <input id="en_taxas" class="input" type="number" step="0.01" placeholder="Taxas" />
            <input id="en_result" class="input" type="number" step="0.01" placeholder="Resultado R$" />
            <button id="en_submit" class="btn md:col-span-1">Adicionar</button>
          </div>
        </div>

        <!-- Mensal -->
        <div id="form-mensal" class="hidden">
          <h3 class="font-semibold mb-2">Mensal (Upsert)</h3>
          <div class="grid md:grid-cols-6 gap-3">
            <input id="me_ano" class="input" type="number" placeholder="Ano (ex: 2025)" />
            <input id="me_mes" class="input" type="number" placeholder="Mês (1-12)" />
            <input id="me_aporte" class="input" type="number" step="0.01" placeholder="Aporte" />
            <input id="me_rendr" class="input" type="number" step="0.01" placeholder="Rend R$" />
            <input id="me_rendp" class="input" type="number" step="0.01" placeholder="Rend %" />
            <input id="me_patr" class="input" type="number" step="0.01" placeholder="Patrimônio" />
            <button id="me_submit" class="btn md:col-span-1">Salvar</button>
          </div>
        </div>

        <!-- IR -->
        <div id="form-ir" class="hidden">
          <h3 class="font-semibold mb-2">IR (Upsert)</h3>
          <div class="grid md:grid-cols-6 gap-3">
            <input id="ir_comp" class="input" placeholder="Competência (YYYY-MM)" />
            <input id="ir_regime" class="input" placeholder="Regime (ex: Carnê-Leão/Ajuste)" />
            <input id="ir_aliq" class="input" type="number" step="0.01" placeholder="Alíquota %" />
            <input id="ir_premios" class="input" type="number" step="0.01" placeholder="Prêmios" />
            <input id="ir_result" class="input" type="number" step="0.01" placeholder="Resultados" />
            <input id="ir_preju" class="input" type="number" step="0.01" placeholder="Prejuízo Comp." />
            <input id="ir_retido" class="input" type="number" step="0.01" placeholder="IR Retido" />
            <input id="ir_darf" class="input" placeholder="DARF nº" />
            <input id="ir_pago" class="input" placeholder="Pago em (YYYY-MM-DD)" />
            <input id="ir_obs" class="input" placeholder="Obs" />
            <button id="ir_submit" class="btn md:col-span-1">Salvar</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    function apiBase() {
      return { url: qs('#apiUrl').value.trim(), key: qs('#apiKey').value.trim() };
    }

    async function apiGet(resource){
      const { url, key } = apiBase();
      const resp = await fetch(`${url}?resource=${encodeURIComponent(resource)}&key=${encodeURIComponent(key)}`);
      return resp.json();
    }

    async function apiPost(payload){
      const { url, key } = apiBase();
      const resp = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(Object.assign({ key }, payload))
      });
      return resp.json();
    }

    function renderTable(el, rows){
      if (!rows || !rows.length){ el.innerHTML = '<div class="text-sm text-slate-500">Sem registros.</div>'; return; }
      const headers = Object.keys(rows[0]);
      const thead = '<thead><tr>' + headers.map(h=>`<th class="text-xs uppercase text-slate-500">${h}</th>`).join('') + '</tr></thead>';
      const tbody = '<tbody>' + rows.map(r=>{
        return '<tr>' + headers.map(h=>`<td class="text-sm">${r[h] ?? ''}</td>`).join('') + '</tr>';
      }).join('') + '</tbody>';
      el.innerHTML = `<div class="overflow-auto"><table class="table">${thead}${tbody}</table></div>`;
    }

    async function loadAll(){
      qs('#btnReload').disabled = true;
      try{
        const [ap, co, op, en, me, ir] = await Promise.all([
          apiGet('aportes'), apiGet('compras'), apiGet('opcoes'),
          apiGet('encerr'), apiGet('mensal'), apiGet('ir')
        ]);
        renderTable(qs('#list-aportes'), ap.data || []);
        renderTable(qs('#list-compras'), co.data || []);
        renderTable(qs('#list-opcoes'),  op.data || []);
        renderTable(qs('#list-encerr'),  en.data || []);
        renderTable(qs('#list-mensal'),  me.data || []);
        renderTable(qs('#list-ir'),      ir.data || []);
      } catch(ex){
        alert('Falha ao carregar: ' + ex.message);
      } finally {
        qs('#btnReload').disabled = false;
      }
    }

    // Tabs
    qsa('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        qsa('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        qsa('#listArea > div').forEach(div=>div.classList.add('hidden'));
        qs('#list-'+tab).classList.remove('hidden');
        qsa('#formsArea > div').forEach(div=>div.classList.add('hidden'));
        const formId = 'form-'+tab;
        if (qs('#'+formId)) qs('#'+formId).classList.remove('hidden');
      });
    });

    // Submits
    qs('#ap_submit').addEventListener('click', async ()=>{
      const payload = {
        action:'aportes/create',
        data: qs('#ap_data').value,
        valor: Number(qs('#ap_valor').value || 0),
        observacao: qs('#ap_obs').value
      };
      const res = await apiPost(payload);
      if (!res.ok) return alert(res.error||'Erro');
      await loadAll();
      qs('#ap_data').value = ''; qs('#ap_valor').value = ''; qs('#ap_obs').value = '';
    });

    qs('#co_submit').addEventListener('click', async ()=>{
      const payload = {
        action:'compras/create',
        data: qs('#co_data').value,
        ticker: qs('#co_ticker').value,
        qtde: Number(qs('#co_qtde').value||0),
        preco: Number(qs('#co_preco').value||0)
      };
      const res = await apiPost(payload);
      if (!res.ok) return alert(res.error||'Erro');
      await loadAll();
      ['#co_data','#co_ticker','#co_qtde','#co_preco'].forEach(id=>qs(id).value='');
    });

    qs('#op_submit').addEventListener('click', async ()=>{
      const payload = {
        action:'opcoes/create',
        data_venda: qs('#op_data_venda').value,
        vencimento: qs('#op_venc').value,
        subjacente: qs('#op_subj').value,
        codigo: qs('#op_codigo').value,
        qtde: Number(qs('#op_qtde').value||0),
        strike: Number(qs('#op_strike').value||0),
        premio: Number(qs('#op_premio').value||0),
        status: 'Aberta',
        resultado: 0
      };
      const res = await apiPost(payload);
      if (!res.ok) return alert(res.error||'Erro');
      await loadAll();
      ['#op_data_venda','#op_venc','#op_subj','#op_codigo','#op_qtde','#op_strike','#op_premio']
        .forEach(id=>qs(id).value='');
    });

    qs('#en_submit').addEventListener('click', async ()=>{
      const payload = {
        action:'encerrar/create',
        codigo: qs('#en_codigo').value,
        data_fechamento: qs('#en_data').value,
        preco_acao: Number(qs('#en_preco').value||0),
        custo_fechar: Number(qs('#en_custo').value||0),
        taxas: Number(qs('#en_taxas').value||0),
        status_final: 'Encerrada',
        resultado: Number(qs('#en_result').value||0),
      };
      const res = await apiPost(payload);
      if (!res.ok) return alert(res.error||'Erro');
      await loadAll();
      ['#en_codigo','#en_data','#en_preco','#en_custo','#en_taxas','#en_result'].forEach(id=>qs(id).value='');
    });

    qs('#me_submit').addEventListener('click', async ()=>{
      const payload = {
        action:'mensal/upsert',
        ano: Number(qs('#me_ano').value||0),
        mes: Number(qs('#me_mes').value||0),
        aporte: Number(qs('#me_aporte').value||0),
        "rend_r$": Number(qs('#me_rendr').value||0),
        "rend_%": Number(qs('#me_rendp').value||0),
        patrimonio: Number(qs('#me_patr').value||0)
      };
      const res = await apiPost(payload);
      if (!res.ok) return alert(res.error||'Erro');
      await loadAll();
    });

    qs('#ir_submit').addEventListener('click', async ()=>{
      const payload = {
        action:'ir/upsert',
        competencia: qs('#ir_comp').value,
        regime: qs('#ir_regime').value,
        aliquota: Number(qs('#ir_aliq').value||0),
        premios: Number(qs('#ir_premios').value||0),
        resultados: Number(qs('#ir_result').value||0),
        prejuizo_comp: Number(qs('#ir_preju').value||0),
        ir_retido: Number(qs('#ir_retido').value||0),
        darf: qs('#ir_darf').value,
        pago_em: qs('#ir_pago').value,
        obs: qs('#ir_obs').value
      };
      const res = await apiPost(payload);
      if (!res.ok) return alert(res.error||'Erro');
      await loadAll();
    });

    qs('#btnReload').addEventListener('click', loadAll);
    loadAll();
  </script>
</body>
</html>
