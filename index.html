<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Venda Coberta – Patrimônio, Aportes e Ciclo Mensal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --card-bg:#fff; --card-br:#e5e7eb; }
    .card{background:var(--card-bg); border:1px solid var(--card-br); border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .input{border:1px solid #cbd5e1; border-radius:10px; padding:.65rem .85rem; width:100%;}
    .btn{border:1px solid #0ea5e9; background:#0284c7; color:#fff; border-radius:10px; padding:.6rem 1rem; font-weight:600;}
    .btn.secondary{background:#fff; color:#0f172a; border-color:#cbd5e1;}
    .tabs button{padding:.45rem .9rem; border-radius:10px; border:1px solid #e5e7eb; background:#fff;}
    .tabs .active{background:#0ea5e9; border-color:#0ea5e9; color:#fff;}
    .kpi .v{font-size:1.15rem; font-weight:800;}
    .table{width:100%;}
    .table th,.table td{border-bottom:1px solid #e5e7eb; padding:.6rem .5rem; text-align:left; white-space:nowrap; font-size:.925rem;}
    .scroll-x{overflow:auto}
    .badge{font-size:.75rem; padding:.25rem .6rem; border-radius:999px; border:1px solid #cbd5e1; background:#fff;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .toast{position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; padding:.75rem 1rem; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.2); opacity:0; transform:translateY(8px); transition:.25s;}
    .toast.show{opacity:1; transform:translateY(0)}
    .chip{display:inline-flex; align-items:center; gap:6px; font-size:.75rem; border:1px solid #cbd5e1; border-radius:999px; padding:.25rem .6rem;}
    .muted{color:#64748b}
    .hidden{display:none}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- Topbar -->
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-full bg-slate-900 text-white grid place-items-center font-bold">B</div>
        <div>
          <div class="font-semibold">Venda Coberta – Patrimônio, Aportes e Ciclo Mensal</div>
          <div class="text-xs text-slate-500">Conectado ao Google Apps Script</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" id="btnExportCsv" class="btn secondary text-xs">Exportar CSV</button>
        <button type="button" id="btnConfigApi" class="btn secondary text-xs">Configurar API</button>
      </div>
    </div>
    <div class="max-w-7xl mx-auto px-4 pb-3">
      <div class="tabs flex gap-2">
        <button type="button" class="active" data-target="page-dashboard">Dashboard</button>
        <button type="button" data-target="page-simulador">Simulador</button>
        <button type="button" data-target="page-ir">Imposto de Renda</button>
      </div>
    </div>
  </header>

  <!-- DASHBOARD -->
  <main id="page-dashboard" class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Config API + Diagnóstico -->
    <section class="card p-4" id="cfgApi">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Configuração da API</h2>
        <div class="flex gap-2">
          <button type="button" id="btnTestApi" class="btn secondary">Testar Status</button>
          <button type="button" id="btnResetApi" class="btn secondary">Resetar</button>
          <button type="button" id="btnSaveApi" class="btn">Salvar</button>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-slate-600">WEB_APP_URL</label>
          <input id="apiUrl" class="input" value="">
        </div>
        <div>
          <label class="text-xs text-slate-600">API_KEY</label>
          <input id="apiKey" class="input" value="">
        </div>
      </div>
      <div id="diag" class="mt-3 text-xs mono text-slate-600"></div>
      <p class="mt-2 text-xs text-slate-500">Se o status falhar por CORS, verifique a URL/implantação. Este app já evita pré-flight no POST.</p>
    </section>

    <!-- KPIs -->
    <section class="grid md:grid-cols-5 gap-3">
      <div class="card p-4"><div class="text-xs text-slate-500">Saldo Atual</div><div class="v" id="kpiSaldo">R$ 0,00</div><div class="text-[11px] text-slate-500">Caixa</div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Aportes no Mês</div><div class="v" id="kpiAporteMes">R$ 0,00</div><div class="text-[11px] text-slate-500">Último mês</div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Rendimento no Mês (%)</div><div class="v" id="kpiRendPerc">0,00%</div><div class="text-[11px] text-slate-500">cálculo simples</div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Prêmio no Ciclo</div><div class="v" id="kpiPremio">R$ 0,00</div><div class="text-[11px] text-slate-500">Soma</div></div>
      <div class="card p-4"><div class="text-xs text-slate-500">Resultado no Ciclo</div><div class="v" id="kpiResultado">R$ 0,00</div><div class="text-[11px] text-slate-500">Com encerramentos</div></div>
    </section>

    <!-- Ciclo + Cards Info -->
    <section class="grid md:grid-cols-3 gap-3">
      <div class="card p-4">
        <h3 class="font-semibold">Ciclo Mensal – 3ª Sexta-feira</h3>
        <p class="text-xs text-slate-500 mb-3">Calcule o vencimento do mês e aplique no formulário.</p>
        <div class="grid grid-cols-3 gap-2">
          <select id="cicloMes" class="input">
            <option value="01">janeiro</option><option value="02">fevereiro</option><option value="03">março</option><option value="04">abril</option>
            <option value="05">maio</option><option value="06">junho</option><option value="07">julho</option><option value="08">agosto</option>
            <option value="09">setembro</option><option value="10">outubro</option><option value="11">novembro</option><option value="12">dezembro</option>
          </select>
          <input id="cicloAno" class="input" type="number" placeholder="AAAA" />
          <button id="btnCalcCiclo" type="button" class="btn">Calcular</button>
        </div>
        <div class="mt-3 text-sm">
          <span class="badge">Vencimento: <span id="cicloVenc">–</span></span>
          <button id="btnAplicarCiclo" type="button" class="btn secondary ml-2">Aplicar no formulário</button>
        </div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold mb-2">Ações Aportadas do Mês</h3>
        <div id="boxAcoesMes" class="text-sm text-slate-700">Sem dados.</div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold mb-2">Opções Vendidas do Mês</h3>
        <div id="boxOpcoesMes" class="text-sm text-slate-700">Sem dados.</div>
      </div>
    </section>

    <!-- Carteira + Opções -->
    <section class="grid md:grid-cols-2 gap-3">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Carteira</h3>
          <div class="text-xs text-slate-500">Preço médio, VM, Livre</div>
        </div>
        <div class="scroll-x mt-2">
          <table class="table">
            <thead><tr>
              <th>Ticker</th><th>Qtde</th><th>Preço Médio</th><th>Preço Atual</th><th>VM</th><th>Livre</th>
            </tr></thead>
            <tbody id="tbCarteira"><tr><td colspan="6" class="text-slate-500 text-sm">Sem dados.</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Opções Cobertas</h3>
          <div class="text-xs text-slate-500">Abertas • Encerradas</div>
        </div>
        <div class="scroll-x mt-2">
          <table class="table">
            <thead><tr>
              <th>Subjacente</th><th>Código</th><th>Qtde</th><th>Strike</th><th>Prêmio</th><th>Venc.</th><th>Status</th><th>Resultado</th><th>Ação</th>
            </tr></thead>
            <tbody id="tbOpcoes"><tr><td colspan="9" class="text-slate-500 text-sm">Sem dados.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Extrato Mensal -->
    <section class="card p-4">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Extrato Mensal</h3>
        <button type="button" id="btnToggleExtrato" class="btn secondary text-xs">▼</button>
      </div>
      <p class="text-xs text-slate-500">Aportes (R$), Rendimentos (R$ e %), Patrimônio no fim do mês.</p>
      <div class="mt-3 grid md:grid-cols-4 gap-2">
        <select id="exMes" class="input">
          <option value="1">jan</option><option value="2">fev</option><option value="3">mar</option><option value="4">abr</option>
          <option value="5">mai</option><option value="6">jun</option><option value="7">jul</option><option value="8">ago</option>
          <option value="9">set</option><option value="10">out</option><option value="11">nov</option><option value="12">dez</option>
        </select>
        <input id="exAno" class="input" type="number" placeholder="AAAA" />
        <button type="button" id="btnBuscarExtrato" class="btn">Buscar</button>
        <button type="button" id="btnAplicarExtrato" class="btn secondary">Aplicar</button>
      </div>
      <div class="scroll-x mt-3">
        <table class="table">
          <thead><tr><th>Mês</th><th>Aporte</th><th>Rend. (R$)</th><th>Rend. (%)</th><th>Patrimônio</th></tr></thead>
          <tbody id="tbExtrato"><tr><td colspan="5" class="text-slate-500 text-sm">Sem dados.</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Formulários -->
    <section class="grid md:grid-cols-3 gap-3">
      <!-- Aporte -->
      <form id="formAporte" class="card p-4" onsubmit="return false;">
        <h3 class="font-semibold">Registrar Aporte</h3>
        <div class="mt-2 grid gap-2">
          <input id="aporteData" class="input" placeholder="dd/mm/aaaa">
          <input id="aporteValor" class="input" type="number" step="0.01" placeholder="R$">
          <input id="aporteObs" class="input" placeholder="Observação">
          <button id="btnAddAporte" type="button" class="btn">Adicionar</button>
        </div>
      </form>

      <!-- Compra -->
      <form id="formCompra" class="card p-4" onsubmit="return false;">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Comprar Ação</h3>
          <span class="badge">Carteira</span>
        </div>
        <div class="mt-2 grid gap-2">
          <input id="compraTicker" class="input" placeholder="Ticker (ex: PCAR3)">
          <input id="compraPreco" class="input" type="number" step="0.01" placeholder="Preço (R$)">
          <input id="compraQtde" class="input" type="number" step="1" placeholder="Qtde">
          <input id="compraData" class="input" placeholder="dd/mm/aaaa">
          <button id="btnAddCompra" type="button" class="btn">Adicionar</button>
        </div>
      </form>

      <!-- Vender Call Coberta -->
      <form id="formOpcao" class="card p-4" onsubmit="return false;">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Vender Call Coberta</h3>
          <span class="badge">Opções</span>
        </div>
        <div class="mt-2 grid gap-2">
          <input id="opSubj" class="input" placeholder="Subjacente (ex: PETR4)">
          <input id="opCodigo" class="input" placeholder="Código (ex: PETRA30)">
          <div class="grid grid-cols-2 gap-2">
            <input id="opQtde" class="input" type="number" step="1" placeholder="Qtde">
            <input id="opStrike" class="input" type="number" step="0.01" placeholder="Strike (R$)">
          </div>
          <input id="opPremio" class="input" type="number" step="0.01" placeholder="Prêmio (R$)">
          <div class="grid grid-cols-2 gap-2">
            <input id="opDataVenda" class="input" placeholder="Data Venda (dd/mm/aaaa)">
            <input id="opVenc" class="input" placeholder="Vencimento (dd/mm/aaaa)">
          </div>
          <button id="btnAddOpcao" type="button" class="btn">Registrar</button>
        </div>
      </form>
    </section>
  </main>

  <!-- SIMULADOR -->
  <main id="page-simulador" class="max-w-7xl mx-auto px-4 py-6 space-y-6 hidden">
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-2">Simulador</h2>
      <p class="text-sm text-slate-600">(em construção) – defina aqui as regras de simulação que desejar que eu implemente.</p>
    </section>
  </main>

  <!-- IR -->
  <main id="page-ir" class="max-w-7xl mx-auto px-4 py-6 space-y-6 hidden">
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-2">Imposto de Renda</h2>
      <p class="text-sm text-slate-600">(em construção) – se quiser, integro com o formulário de <b>IR (upsert)</b> que já existe no backend.</p>
    </section>
  </main>

  <div id="toast" class="toast">ok</div>

  <script>
    // ===== Utils
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const money = n => (new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'})).format(Number(n||0));
    const pct   = n => (Number(n||0)).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) + '%';
    const BR = (iso) => { if(!iso) return ''; const d = new Date(iso); if(isNaN(d)) return iso; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; };
    function toast(msg){ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1600); }

    // Tabs
    qsa('.tabs button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        qsa('.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.dataset.target;
        qsa('main[id^="page-"]').forEach(m=> m.classList.add('hidden'));
        qs('#'+id).classList.remove('hidden');
      });
    });

    // Bloqueio de submit/href em formulários:
    document.addEventListener('submit', (e)=>{ e.preventDefault(); e.stopPropagation(); }, true);

    // ===== API cfg (força defaults na 1ª carga)
    const DEFAULT_URL="https://script.google.com/macros/s/AKfycbyRpqe93H1IFKWQuJ8Eu_f3SnZGKnWIXUvizy_iAhmHlm5IuQj0Sf388E-S5cEN_7BbJw/exec";
    const DEFAULT_KEY="Vc7@Rendimentos#2025!";

    function forceDefaultsOnce(){
      const savedUrl = localStorage.getItem('api.url');
      if (!savedUrl || !savedUrl.includes("AKfycbyRpqe93H1I")) {
        localStorage.setItem('api.url', DEFAULT_URL);
        localStorage.setItem('api.key', DEFAULT_KEY);
      }
    }
    function loadApiConfig(){
      qs('#apiUrl').value = localStorage.getItem('api.url') || DEFAULT_URL;
      qs('#apiKey').value = localStorage.getItem('api.key') || DEFAULT_KEY;
      diag(`WEB_APP_URL em uso: ${qs('#apiUrl').value}`);
    }
    function saveApiConfig(){
      localStorage.setItem('api.url', qs('#apiUrl').value.trim());
      localStorage.setItem('api.key', qs('#apiKey').value.trim());
      toast('Configuração salva.');
      diag(`WEB_APP_URL em uso: ${qs('#apiUrl').value}`);
    }
    function resetApiConfig(){
      localStorage.removeItem('api.url');
      localStorage.removeItem('api.key');
      loadApiConfig();
      toast('Configuração resetada.');
    }
    function apiBase(){ return { url:qs('#apiUrl').value.trim(), key:qs('#apiKey').value.trim() }; }

    // ===== Log/Diag na UI
    function diag(msg){
      const box = qs('#diag');
      const now = new Date().toLocaleTimeString();
      box.innerHTML = `<div>[${now}] ${msg}</div>` + box.innerHTML;
      console.log('[DIAG]', msg);
    }

    // ===== API calls (POST sem pré-flight)
    async function apiGet(resource){
      const {url,key}=apiBase();
      diag('GET: ' + resource);
      const r=await fetch(`${url}?resource=${encodeURIComponent(resource)}&key=${encodeURIComponent(key)}`);
      const ct=r.headers.get('content-type')||'';
      if(!ct.includes('application/json')){
        const t=await r.text();
        diag('GET não-JSON: ' + t.slice(0,120));
        throw new Error('GET não-JSON (publique o Web App como "Qualquer pessoa").');
      }
      const j=await r.json(); if(!j.ok) throw new Error(j.error||'Falha'); return j.data||[];
    }
    async function apiPost(body){
      const {url,key}=apiBase();
      diag('POST: ' + (body.action||''));
      const r=await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'}, // evita pré-flight
        body:JSON.stringify(Object.assign({key},body))
      });
      const ct=r.headers.get('content-type')||'';
      if(!ct.includes('application/json')){
        const t=await r.text();
        diag('POST não-JSON: ' + t.slice(0,120));
        throw new Error('POST não-JSON (ver implantação e URL).');
      }
      const j=await r.json(); if(!j.ok) throw new Error(j.error||'Falha'); return j.data;
    }

    // ===== Helpers
    function toISO(dmy){
      const m=/^\s*(\d{2})[\/\-](\d{2})[\/\-](\d{4})\s*$/.exec(dmy||'');
      if(!m) return dmy; const [_,dd,mm,yyyy]=m; return `${yyyy}-${mm}-${dd}`;
    }
    function inMonth(iso, y, m){
      if(!iso) return false;
      const d = new Date(iso);
      if(isNaN(d)) return false;
      return d.getFullYear()===y && (d.getMonth()+1)===m;
    }

    // ===== Renders (preenchendo apenas TBODY)
    function renderAportes(rows){
      const tb=qs('#tbCarteira'); // carteira ainda placeholder
    }
    function renderCompras(rows){
      // sem carteira consolidada por enquanto
    }
    function renderOpcoes(opcoes){
      const tb = qs('#tbOpcoes'); if(!tb) return;
      if(!opcoes || !opcoes.length){ tb.innerHTML = `<tr><td colspan="9" class="text-slate-500 text-sm">Sem dados.</td></tr>`; return; }
      tb.innerHTML = opcoes.map(o => `
        <tr>
          <td>${o.subjacente ?? ''}</td>
          <td>${o.codigo ?? ''}</td>
          <td>${o.qtde ?? ''}</td>
          <td>${o.strike ?? ''}</td>
          <td>${o.premio ?? ''}</td>
          <td>${BR(o.vencimento) || ''}</td>
          <td>${o.status ?? ''}</td>
          <td>${o.resultado ?? ''}</td>
          <td><button data-cod="${o.codigo||''}" class="btn secondary text-xs btnEncerrar">Encerrar</button></td>
        </tr>
      `).join('');
      qsa('.btnEncerrar').forEach(b=> b.addEventListener('click', onEncerrarClick));
    }
    function renderEncerr(rows){
      // (mantém placeholder – preencher quando precisar)
    }
    function renderExtrato(mensal){
      const tb = qs('#tbExtrato'); if(!tb) return;
      if(!mensal || !mensal.length){ tb.innerHTML = `<tr><td colspan="5" class="text-slate-500 text-sm">Sem dados.</td></tr>`; return; }
      tb.innerHTML = mensal.map(m => `
        <tr>
          <td>${String(m.mes).padStart(2,'0')}/${m.ano}</td>
          <td>${money(m.aporte||0)}</td>
          <td>${money(m['rend_r$']||0)}</td>
          <td>${pct(m['rend_%']||0)}</td>
          <td>${money(m.patrimonio||0)}</td>
        </tr>
      }).join('');
    }

    // ===== Dados globais (para cálculos)
    let DATA = { aportes:[], compras:[], opcoes:[], encerr:[], mensal:[] };

    // ===== Dados + KPIs
    async function reloadAll(){
      try{
        const [aportes, compras, opcoes, encerr, mensal] = await Promise.all([
          apiGet('aportes'), apiGet('compras'), apiGet('opcoes'),
          apiGet('encerr'), apiGet('mensal')
        ]);
        DATA = { aportes, compras, opcoes, encerr, mensal };

        // KPIs OK + cálculos pedido
        const now = new Date();
        const y = now.getFullYear(), m = now.getMonth()+1;

        const aporteMes = (aportes||[]).filter(a=>inMonth(a.data, y, m))
                                       .reduce((s,a)=> s + Number(a.valor||0), 0);
        const premioMes = (opcoes||[]).filter(o=>inMonth(o.data_venda, y, m))
                                      .reduce((s,o)=> s + Number(o.premio||0), 0);
        const resultadoMes = (encerr||[]).filter(e=>inMonth(e.data_fechamento, y, m))
                                         .reduce((s,e)=> s + Number(e.resultado||0), 0);

        qs('#kpiAporteMes').textContent = money(aporteMes);
        qs('#kpiPremio').textContent = money(premioMes);
        qs('#kpiResultado').textContent = money(resultadoMes);
        // Rendimento % simples (ajuste a fórmula se quiser)
        const baseSimples = aporteMes + premioMes + (resultadoMes>0?resultadoMes:0) || 1;
        const rendPerc = (resultadoMes/baseSimples)*100;
        qs('#kpiRendPerc').textContent = pct(rendPerc);

        // Ações Aportadas do Mês (mostrar valor aportado)
        qs('#boxAcoesMes').textContent = aporteMes>0 ? `Valor aportado no mês: ${money(aporteMes)}` : 'Sem dados.';

        // Opções vendidas do mês (visível)
        const doMes = (opcoes||[]).filter(o=>inMonth(o.data_venda, y, m));
        qs('#boxOpcoesMes').innerHTML = doMes.length
          ? doMes.map(o=>`${o.codigo} • ${o.subjacente} • Prêmio ${money(o.premio)} • Venc. ${BR(o.vencimento)}`).join('<br>')
          : 'Sem dados.';

        // Tabelas
        renderOpcoes(opcoes);

        // Extrato: render dados existentes (se houver)
        renderExtrato(mensal);
      }catch(err){
        diag('reloadAll falhou: ' + err.message);
        alert('Falha ao carregar dados: ' + err.message);
      }
    }

    // ===== Encerrar Opção
    async function onEncerrarClick(e){
      e.preventDefault();
      const cod = e.currentTarget.getAttribute('data-cod');
      const data_fechamento = prompt('Data de fechamento (dd/mm/aaaa):'); if(!data_fechamento) return;
      const preco_acao = Number(prompt('Preço da ação (R$):')||0);
      const custo_fechar = Number(prompt('Custo para recomprar/encerrar (R$):')||0);
      const taxas = Number(prompt('Taxas (R$):')||0);
      const resultado = Number(prompt('Resultado líquido (R$):')||0);
      const payload = { action:'encerrar/create', codigo: cod, data_fechamento: toISO(data_fechamento), preco_acao, custo_fechar, taxas, status_final:'Encerrada', resultado };
      try{ await apiPost(payload); toast('Encerramento registrado.'); reloadAll(); } catch(err){ toast('Erro: '+err.message); }
    }

    // ===== Extrato Mensal (calcular + aplicar)
    let ultimoCalculoMensal = null;
    function calcularMensalLocal(ano, mes){
      const aporte = (DATA.aportes||[]).filter(a=>inMonth(a.data, ano, mes))
                        .reduce((s,a)=> s + Number(a.valor||0), 0);
      const rendPremios = (DATA.opcoes||[]).filter(o=>inMonth(o.data_venda, ano, mes))
                          .reduce((s,o)=> s + Number(o.premio||0), 0);
      const resultados = (DATA.encerr||[]).filter(e=>inMonth(e.data_fechamento, ano, mes))
                          .reduce((s,e)=> s + Number(e.resultado||0), 0);
      const rend_r$ = rendPremios + resultados;
      // Fórmula simples para % (ajuste se quiser)
      const base = Math.max(1, aporte + rendPremios);
      const rend_% = (rend_r$ / base) * 100;
      const patrimonio = aporte + rend_r$; // placeholder (defina fórmula que preferir)

      return { ano, mes, aporte, "rend_r$": rend_r$, "rend_%": rend_% , patrimonio };
    }

    qs('#btnBuscarExtrato').addEventListener('click', (e)=>{
      e.preventDefault();
      const ano = Number(qs('#exAno').value || new Date().getFullYear());
      const mes = Number(qs('#exMes').value || (new Date().getMonth()+1));
      ultimoCalculoMensal = calcularMensalLocal(ano, mes);
      renderExtrato([ultimoCalculoMensal]);
    });

    qs('#btnAplicarExtrato').addEventListener('click', async (e)=>{
      e.preventDefault();
      if(!ultimoCalculoMensal){ toast('Clique em Buscar antes de Aplicar.'); return; }
      const m = ultimoCalculoMensal;
      try{
        await apiPost({ action:'mensal/upsert', ano:m.ano, mes:m.mes, aporte:m.aporte, "rend_r$":m["rend_r$"], "rend_%":m["rend_%"], patrimonio:m.patrimonio });
        toast('Mensal aplicado!');
        reloadAll();
      }catch(err){ toast('Erro: '+err.message); }
    });

    // ===== Eventos UI config
    qs('#btnSaveApi').addEventListener('click', (e)=>{ e.preventDefault(); saveApiConfig(); });
    qs('#btnResetApi').addEventListener('click', (e)=>{ e.preventDefault(); resetApiConfig(); });
    qs('#btnTestApi').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        const data = await apiGet('status');
        diag('STATUS OK: ' + JSON.stringify(data));
        alert('Status OK. Conexão estabelecida.');
      }catch(err){
        diag('STATUS ERRO: ' + err.message);
        alert('Status ERRO: ' + err.message);
      }
    });

    // ===== Formulários (Aporte/Compra/Opção)
    qs('#btnAddAporte').addEventListener('click', async (e)=>{
      e.preventDefault();
      const data  = toISO(qs('#aporteData').value);
      const valor = Number(qs('#aporteValor').value || 0);
      const obs   = qs('#aporteObs').value || '';
      if (!data || !valor){ alert('Informe data e valor.'); return; }
      try{
        await apiPost({ action:'aportes/create', data, valor, observacao: obs });
        toast('Aporte salvo!'); ['#aporteData','#aporteValor','#aporteObs'].forEach(id=>qs(id).value='');
        reloadAll();
      }catch(err){ alert('Erro ao salvar: '+err.message); }
    });

    qs('#btnAddCompra').addEventListener('click', async (e)=>{
      e.preventDefault();
      const ticker=qs('#compraTicker').value.trim();
      const preco =Number(qs('#compraPreco').value || 0);
      const qtde  =Number(qs('#compraQtde').value || 0);
      const data  =toISO(qs('#compraData').value);
      if(!ticker||!qtde||!preco||!data){ alert('Preencha todos os campos da compra.'); return; }
      try{
        await apiPost({ action:'compras/create', data, ticker, qtde, preco });
        toast('Compra salva!'); ['#compraTicker','#compraPreco','#compraQtde','#compraData'].forEach(id=>qs(id).value='');
        reloadAll();
      }catch(err){ alert('Erro ao salvar: '+err.message); }
    });

    qs('#btnAddOpcao').addEventListener('click', async (e)=>{
      e.preventDefault();
      const sub=qs('#opSubj').value.trim(), cod=qs('#opCodigo').value.trim();
      const qtde=Number(qs('#opQtde').value||0), strike=Number(qs('#opStrike').value||0);
      const premio=Number(qs('#opPremio').value||0);
      const dv=toISO(qs('#opDataVenda').value), venc=toISO(qs('#opVenc').value);
      if(!sub||!cod||!qtde||!strike||!premio||!dv||!venc){ alert('Preencha todos os campos da opção.'); return; }
      try{
        await apiPost({ action:'opcoes/create', data_venda:dv, vencimento:venc, subjacente:sub, codigo:cod, qtde, strike, premio, status:'Aberta', resultado:0 });
        toast('Opção registrada!'); ['#opSubj','#opCodigo','#opQtde','#opStrike','#opPremio','#opDataVenda','#opVenc'].forEach(id=>qs(id).value='');
        reloadAll();
      }catch(err){ alert('Erro ao salvar: '+err.message); }
    });

    // Ciclo – 3ª sexta
    function terceiraSexta(ano, mes){
      const d=new Date(ano, mes-1, 1); const sextas=[];
      while(d.getMonth()===mes-1){ if(d.getDay()===5) sextas.push(new Date(d)); d.setDate(d.getDate()+1); }
      return sextas[2] || sextas[1] || sextas[0];
    }
    qs('#btnCalcCiclo').addEventListener('click',(e)=>{
      e.preventDefault();
      const mes=Number(qs('#cicloMes').value||'1'), ano=Number(qs('#cicloAno').value||new Date().getFullYear());
      const dt=terceiraSexta(ano,mes); if(!dt){ qs('#cicloVenc').textContent='–'; return; }
      const dd=String(dt.getDate()).padStart(2,'0'), mm=String(dt.getMonth()+1).padStart(2,'0'), yyyy=dt.getFullYear();
      qs('#cicloVenc').textContent=`${dd}/${mm}/${yyyy}`;
    });
    qs('#btnAplicarCiclo').addEventListener('click',(e)=>{
      e.preventDefault();
      const v=qs('#cicloVenc').textContent.trim();
      if(!/^\d{2}\/\d{2}\/\d{4}$/.test(v)){ alert('Calcule o vencimento primeiro.'); return; }
      qs('#opVenc').value=v; toast('Vencimento aplicado no formulário de Opções.');
    });

    // ===== Init
    forceDefaultsOnce();
    loadApiConfig();
    diag('Iniciado. URL atual: ' + (qs('#apiUrl').value));
    reloadAll();
  </script>
</body>
</html>
