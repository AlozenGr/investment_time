<!DOCTYPE html>
qs('#kpiPremio').textContent = money(somaPremio);
qs('#kpiResultado').textContent = money(somaResEnc);
// Rendimento % simples (resultado sobre base de aporte + prêmio do mês)
const base = Math.max(1, somaAporte + somaPremio);
qs('#kpiRendPerc').textContent = pct((somaResEnc/base)*100);
// Saldo (placeholder)
qs('#kpiSaldo').textContent = money(somaAporte);


// Cards: Ações Aportadas do mês / Opções do mês (com fallback por vencimento)
qs('#boxAcoesMes').textContent = somaAporte>0 ? `Valor aportado no mês: ${money(somaAporte)}` : 'Sem dados.';
qs('#boxOpcoesMes').innerHTML = opcoesMes.length
? opcoesMes.map(o=>`${o.codigo} • ${o.subjacente} • Prêmio ${money(o.premio)} • Venc. ${BR(o.vencimento)}`).join('<br>')
: 'Sem dados.';


// Extrato: se já houver itens no back, apenas mantém; o Buscar/Aplicar usa seus próprios controles
}


// ===== Extrato (local)
let ultimoCalc = null;
function calcularMensalLocal(ano, mes){
const aporte = (DATA.aportes||[]).filter(a=>inMonth(a.data,ano,mes)).reduce((s,a)=>s+Number(a.valor||0),0);
const premios= (DATA.opcoes ||[]).filter(o=>inMonth(o.data_venda,ano,mes)).reduce((s,o)=>s+Number(o.premio||0),0);
const resultados=(DATA.encerr||[]).filter(e=>inMonth(e.data_fechamento,ano,mes)).reduce((s,e)=>s+Number(e.resultado||0),0);
const rend_rs = premios + resultados;
const base = Math.max(1, aporte + premios);
const rend_pct = (rend_rs/base)*100;
const patrimonio = aporte + rend_rs; // ajuste se desejar outra fórmula
return {ano,mes,aporte, "rend_r$":rend_rs, "rend_%":rend_pct, patrimonio};
}
qs('#btnBuscarExtrato').addEventListener('click', ()=>{
const ano = Number(qs('#exAno').value || new Date().getFullYear());
const mes = Number(qs('#exMes').value || (new Date().getMonth()+1));
ultimoCalc = calcularMensalLocal(ano,mes);
renderExtrato([ultimoCalc]);
});
qs('#btnAplicarExtrato').addEventListener('click', async ()=>{
if(!ultimoCalc){ alert('Clique em Buscar antes de Aplicar.'); return; }
await apiPost({ action:'mensal/upsert', ...ultimoCalc });
alert('Mensal aplicado!');
await reloadAll();
});


// ===== Fluxo principal
async function reloadAll(){
const [aportes, compras, opcoes, encerr, mensal] = await Promise.all([
apiGet('aportes'), apiGet('compras'), apiGet('opcoes'), apiGet('encerr'), apiGet('mensal')
]);
DATA = { aportes, compras, opcoes, encerr, mensal };
renderOpcoes(opcoes);
renderExtrato(mensal);
updateAllCalculations();
}


// Init
(function init(){
// contexto inicial = mês atual
syncCtxToUI();
qs('#exMes').value = String(CTX.mes); qs('#exAno').value = String(CTX.ano);
reloadAll();
})();
</script>
</body>
</html>
