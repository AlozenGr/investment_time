<!DOCTYPE html>
await apiPost({ action:'aportes/create', data: toISO(dataBr), valor, observacao: obs });
qs('#aporteData').value = ''; qs('#aporteValor').value = ''; qs('#aporteObs').value = '';
await reloadAll();
}, 'Aporte registrado!'));


qs('#btnAddCompra')?.addEventListener('click', () => run(async () => {
const ticker = (qs('#compraTicker').value || '').trim().toUpperCase();
const preco = toNum(qs('#compraPreco').value);
const qtde = Math.trunc(toNum(qs('#compraQtde').value));
const dataBr = (qs('#compraData').value || '').trim();
if (!ticker || !preco || !qtde || !dataBr) throw new Error('Preencha Ticker, Preço, Qtde e Data.');
await apiPost({ action:'compras/create', data: toISO(dataBr), ticker, qtde, preco });
['#compraTicker','#compraPreco','#compraQtde','#compraData'].forEach(s=>qs(s).value='');
await reloadAll();
}, 'Compra registrada!'));


qs('#btnAddOpcao')?.addEventListener('click', () => run(async () => {
const sub = (qs('#opSubj').value || '').trim().toUpperCase();
const cod = (qs('#opCodigo').value || '').trim().toUpperCase();
const qtde = Math.trunc(toNum(qs('#opQtde').value));
const k = toNum(qs('#opStrike').value);
const pr = toNum(qs('#opPremio').value);
const dv = (qs('#opDataVenda').value || '').trim();
const venc = (qs('#opVenc').value || '').trim();
if (!sub || !cod || !qtde || !k || !pr || !dv || !venc) throw new Error('Preencha Subjacente, Código, Qtde, Strike, Prêmio, Data de Venda e Vencimento.');
await apiPost({ action:'opcoes/create', data_venda: toISO(dv), vencimento: toISO(venc), subjacente: sub, codigo: cod, qtde, strike: k, premio: pr, status:'Aberta', resultado:0 });
['#opSubj','#opCodigo','#opQtde','#opStrike','#opPremio','#opDataVenda','#opVenc'].forEach(s=>qs(s).value='');
await reloadAll();
}, 'Call coberta registrada!'));


// ===== Fluxo principal
async function reloadAll(){
const [aportes, compras, opcoes, encerr, mensal] = await Promise.all([
apiGet('aportes'), apiGet('compras'), apiGet('opcoes'), apiGet('encerr'), apiGet('mensal')
]);
DATA = { aportes, compras, opcoes, encerr, mensal };
await refreshPrices();
updateAllCalculations();
updatePatrimonioAndKPIs();
renderOpcoes(opcoes);
renderExtrato(mensal);
// IR default
qs('#irMes').value = String(CTX.mes);
qs('#irAno').value = String(CTX.ano);
updateIrPanel();
}


document.getElementById('btnAtualizarPrecos').addEventListener('click', async ()=>{
await refreshPrices();
updatePatrimonioAndKPIs();
alert('Cotações atualizadas!');
});


setInterval(async ()=>{ try { await refreshPrices(); updatePatrimonioAndKPIs(); } catch(e){} }, 60000);


// Exportar CSV
qs('#btnExportCsv').addEventListener('click', ()=>{
const rows = DATA.mensal && DATA.mensal.length ? DATA.mensal : buildMonthlyAggFromRaw().map(r=>({ano:r.ano,mes:r.mes,aporte:r.aporte,"rend_r$":r.rend_rs,"rend_%":r.rend_pct,patrimonio:r.patrimonio}));
if(!rows.length){ alert('Sem dados para exportar.'); return; }
let csv = 'ano,mes,aporte,rend_r$,rend_%,patrimonio\n';
rows.forEach(r=>{ csv += `${r.ano},${r.mes},${toNum(r.aporte)},${toNum(r["rend_r$"])||toNum(r.rend_rs)},${toNum(r["rend_%"])||toNum(r.rend_pct)},${toNum(r.patrimonio)}\n`; });
const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a');
a.href = url; a.download = 'mensal.csv'; a.click(); URL.revokeObjectURL(url);
});


// Init
(function init(){
qs('#ctxMes').value = String(CTX.mes); qs('#ctxAno').value = String(CTX.ano);
qs('#exMes').value = String(CTX.mes); qs('#exAno').value = String(CTX.ano);
qs('#irMes').value = String(CTX.mes); qs('#irAno').value = String(CTX.ano);
renderCash(); renderOptMtm();
reloadAll();
})();
</script>
</body>
</html>
