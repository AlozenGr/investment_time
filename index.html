qs('#btnAddOpcao')?.addEventListener('click', () => run(async () => {
  const sub  = (qs('#opSubj').value || '').trim().toUpperCase();
  const cod  = (qs('#opCodigo').value || '').trim().toUpperCase();
  const qtde = Math.trunc(toNum(qs('#opQtde').value));
  const k    = toNum(qs('#opStrike').value);
  const pr   = toNum(qs('#opPremio').value);
  const dv   = (qs('#opDataVenda').value || '').trim();   // dd/mm/aaaa
  const venc = (qs('#opVenc').value || '').trim();

  if (!sub || !cod || !qtde || !k || !pr || !dv || !venc){
    throw new Error('Preencha Subjacente, Código, Qtde, Strike, Prêmio, Data de Venda e Vencimento.');
  }

  await apiPost({
    action: 'opcoes/create',
    data_venda: toISO(dv),
    vencimento: toISO(venc),
    subjacente: sub,
    codigo: cod,
    qtde,
    strike: k,
    premio: pr,
    status: 'Aberta',
    resultado: 0
  });

  // limpar e recarregar
  ['#opSubj','#opCodigo','#opQtde','#opStrike','#opPremio','#opDataVenda','#opVenc']
    .forEach(sel => qs(sel).value = '');
  await reloadAll();
}, 'Call coberta registrada!'));
